name: Compiler Performance Benchmark

on:
  pull_request:
  workflow_dispatch:

jobs:
  performance-benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout master branch
        uses: actions/checkout@v4
        with:
          ref: master
          path: master

      - name: Bootstrap D environment
        uses: dlang-community/setup-dlang@v2
        with:
          compiler: dmd

      - name: Build PR compiler
        run: |
          cd pr
          make -f posix.mak AUTO_BOOTSTRAP=1 -j$(nproc)

      - name: Build Master compiler
        run: |
          cd master
          make -f posix.mak AUTO_BOOTSTRAP=1 -j$(nproc)

      - name: Export compiler paths
        run: |
          echo "PR_COMPILER=$GITHUB_WORKSPACE/pr/generated/linux/release/64/dmd" >> $GITHUB_ENV
          echo "MASTER_COMPILER=$GITHUB_WORKSPACE/master/generated/linux/release/64/dmd" >> $GITHUB_ENV

      - name: Run compilation benchmarks
        run: |
          # Prepare report
          echo "## System Configuration" > benchmark.md
          echo "- Cores: $(nproc)" >> benchmark.md
          echo "- CPU: $(lscpu | awk -F: '/Model name/ {print $2}' | xargs)" >> benchmark.md
          echo "- Memory: $(free -m | awk '/Mem:/ {print $2}') MB" >> benchmark.md
          echo "- Kernel: $(uname -r)" >> benchmark.md

          # Benchmark function
          benchmark() {
            local compiler=$1
            local prefix=$2
            local src="$3"

            echo -e "\n### $prefix Compiler" >> benchmark.md
            /usr/bin/time -v "$compiler" -O -release -inline -boundscheck=off \
              -of="$GITHUB_WORKSPACE/${prefix}-binary" "$src" \
              2>&1 | tee metrics-${prefix}.txt

            echo -e "\n**Metrics**:" >> benchmark.md
            grep -E 'Elapsed \(wall clock\)|Maximum resident set size' metrics-${prefix}.txt \
              | sed 's/.*://' \
              | xargs \
              >> benchmark.md

            echo "- Binary size: $(stat -c '%s' $GITHUB_WORKSPACE/${prefix}-binary) bytes" >> benchmark.md
          }

          # Run against the single test file
          FILE_PATH="pr/compiler/test/benchmark/compile_heavy.d"
          benchmark "$PR_COMPILER" "PR"     "$GITHUB_WORKSPACE/$FILE_PATH"
          benchmark "$MASTER_COMPILER" "Master" "$GITHUB_WORKSPACE/$FILE_PATH"

      - name: Generate comparison report
        run: |
          pr_time=$(grep 'Elapsed (wall clock)' metrics-PR.txt | awk '{print $NF}')
          master_time=$(grep 'Elapsed (wall clock)' metrics-Master.txt | awk '{print $NF}')
          time_diff=$(echo "$pr_time - $master_time" | bc | awk '{printf \"%.2f\", $0}')

          pr_mem=$(grep 'Maximum resident set size' metrics-PR.txt | awk '{print $NF}')
          master_mem=$(grep 'Maximum resident set size' metrics-Master.txt | awk '{print $NF}')
          mem_diff=$((pr_mem - master_mem))

          pr_size=$(stat -c '%s' PR-binary)
          master_size=$(stat -c '%s' Master-binary)
          size_diff=$((pr_size - master_size))

          echo -e "\n## Performance Comparison" >> benchmark.md
          cat <<EOF >> benchmark.md
| Metric                         | PR       | Master   | Difference |
|--------------------------------|----------|----------|------------|
| **Compilation Time (s)**       | $pr_time  | $master_time  | \`$time_diff\`    |
| **Memory Usage (KB)**          | $pr_mem   | $master_mem   | \`$mem_diff\`     |
| **Binary Size (bytes)**        | $pr_size  | $master_size  | \`$size_diff\`    |
EOF

      - name: Upload benchmark report
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmark
          path: benchmark.md
